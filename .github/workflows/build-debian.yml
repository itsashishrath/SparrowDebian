name: Build and Publish Sparrow Debian Package

on:
  push:
    branches:
      - build/linux-debian
    paths:
      - 'apps/@sparrow-desktop/**'
      - 'apps/@sparrow-web/**'
      - '.github/workflows/build-debian.yml'

jobs:
  build-debian:
    runs-on: ubuntu-latest

    env:
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Rust 1.82.0
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.82.0
          override: true

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            pkg-config libssl-dev libcairo2-dev \
            libwebkit2gtk-4.1-dev build-essential \
            curl wget file libxdo-dev \
            libayatana-appindicator3-dev librsvg2-dev \
            gnupg software-properties-common

      - name: Setup Node.js 22
        run: |
          curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
          sudo apt-get install -y nodejs
      - name: Install Yarn (Ubuntu 24.04 compatible)
        run: |
          # Create keyring directory if it doesn't exist
          sudo mkdir -p /etc/apt/keyrings

          # Download and store Yarn GPG key in the proper format
          curl -fsSL https://dl.yarnpkg.com/debian/pubkey.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/yarn.gpg

          # Add Yarn APT repo with signed-by directive
          echo "deb [signed-by=/etc/apt/keyrings/yarn.gpg] https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list

          # Update and install Yarn
          sudo apt update
          sudo apt install -y yarn

      - name: Inject .env for Desktop
        run: |
          echo "${{ vars.DESKTOP_ENV_FILE }}" > apps/@sparrow-desktop/.env

      - name: Inject .env for WEB
        run: |
          echo "${{ vars.WEB_ENV_FILE }}" > apps/@sparrow-web/.env

      - name: Verify and print Desktop .env
        run: |
          echo "ðŸ“ Desktop .env location: $(realpath apps/@sparrow-desktop/.env)"
          echo "ðŸ“¦ Desktop .env contents:"
          cat apps/@sparrow-desktop/.env

      - name: Verify and print Web .env
        run: |
          echo "ðŸ“ Web .env location: $(realpath apps/@sparrow-web/.env)"
          echo "ðŸ“¦ Web .env contents:"
          cat apps/@sparrow-web/.env

      - name: Install project dependencies
        run: yarn

      - name: Build Tauri app
        run: yarn workspace @sparrow/desktop tauri build --debug

      - name: Generate DEB metadata
        working-directory: apps/@sparrow-desktop/src-tauri/target/debug/bundle
        run: |
          mkdir -p ../../../../../../debs
          cp deb/sparrow_*.deb ../../../../../../debs/
          cd ../../../../../../
          dpkg-scanpackages debs /dev/null | sed 's|Filename: debs/|Filename: |' | tee debs/Packages | gzip -9c > debs/Packages.gz
          
      - name: Prepare publish directory
        run: |
          mkdir gh-pages-publish
          cp -r debs gh-pages-publish/

      - name: Upload to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ vars.GH_TOKEN }}
          publish_dir: ./gh-pages-publish
 
